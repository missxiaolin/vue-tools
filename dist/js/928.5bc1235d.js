"use strict";(self["webpackChunka"]=self["webpackChunka"]||[]).push([[928],{16928:function(e,t,i){i.r(t),i.d(t,{default:function(){return h}});var n=function(){var e=this,t=e._self._c;return t("div",{staticClass:"content"},[t("div",{staticClass:"fabric-con"},[t("div",{staticClass:"fabric-body",attrs:{id:"canvas-box"},on:{drop:function(t){return e.drop(t)},touchstart:function(t){return e.drop(t)},dragover:function(t){return e.allowDrop(t)}}},[t("canvas",{staticClass:"root"}),t("canvas",{attrs:{id:"designCanvas"}})])])])},s=[],o=i(71312),a=o.Z,r=i(43736),c=(0,r.Z)(a,n,s,!1,null,"4a1ca7d7",null),h=c.exports},71312:function(__unused_webpack_module,__webpack_exports__,__webpack_require__){var core_js_modules_es_array_push_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(57658),core_js_modules_es_array_push_js__WEBPACK_IMPORTED_MODULE_0___default=__webpack_require__.n(core_js_modules_es_array_push_js__WEBPACK_IMPORTED_MODULE_0__),fabric__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(69662),fabric__WEBPACK_IMPORTED_MODULE_1___default=__webpack_require__.n(fabric__WEBPACK_IMPORTED_MODULE_1__),_utils_ruler__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(71718);__webpack_exports__["Z"]={components:{},created(){},mounted(){this.init(),this.ruler=new _utils_ruler__WEBPACK_IMPORTED_MODULE_2__.Z({canvasId:".root",width:1e3}).render()},data(){return{zoomPoint:"",zoom:1,viewportTransform:null,design:"",ActiveObject:{},ActiveGroup:[],ruler:null,timer:null,lastTime:null}},methods:{init:function(){let e=this;e.design=new fabric__WEBPACK_IMPORTED_MODULE_1__.fabric.Canvas("designCanvas",{backgroundColor:""}),fabric__WEBPACK_IMPORTED_MODULE_1__.fabric.Object.prototype.originX=fabric__WEBPACK_IMPORTED_MODULE_1__.fabric.Object.prototype.originY="center";let t=document.getElementById("canvas-box");this.contextMenuTarget=t,e.design.setWidth(t.offsetWidth),e.design.setHeight(t.offsetHeight),this.zoomPoint=new fabric__WEBPACK_IMPORTED_MODULE_1__.fabric.Point(e.design.width/2,e.design.height/2),e.design.on("mouse:wheel",(function(t){var i=t.e.deltaY;e.zoom=e.design.getZoom(),e.zoom*=.999**i,e.zoom>20&&(e.zoom=20),e.zoom<.01&&(e.zoom=.01),this.zoomToPoint(e.zoomPoint,e.zoom),e.mouseWheel(),t.e.preventDefault(),t.e.stopPropagation(),e.viewportTransform=this.viewportTransform}))},mouseWheel:function(){this.ruler.update({scale:this.zoom})},transformMouse(e,t){return{x:e/1,y:t/1}},drag:function(e,t){e.dataTransfer.setData("item",JSON.stringify(t))},allowDrop:function(e){e.preventDefault()},drop:function(e){var t="";this.design.zoomToPoint(this.zoomPoint,this.zoom);var i=JSON.parse(e.dataTransfer.getData("item")),n=e.offsetX,s=e.offsetY;switch(this.viewportTransform&&(n=(n-this.viewportTransform[4])/this.zoom,s=(s-this.viewportTransform[5])/this.zoom),i.left=n,i.top=s,i.data["uuid"]=uuid(),i.data.type){case"Line":t=new fabric__WEBPACK_IMPORTED_MODULE_1__.fabric.Line([n,i.width,n,s],i);break;case"IText":t=new fabric__WEBPACK_IMPORTED_MODULE_1__.fabric.IText("文字信息",i);break;case"Echart":t=this.getCanvas(i);break;case"Svg":this.getSvg(i);break;default:t=new fabric__WEBPACK_IMPORTED_MODULE_1__.fabric[i.data.type](i);break}""!=t&&this.addObject(t)},addObject:function(e){e.toObject=function(e){return function(t){return fabric__WEBPACK_IMPORTED_MODULE_1__.fabric.util.object.extend(e.call(this,t),{data:this.data})}}(e.toObject),this.design.add(e)},getCanvas:function(json){var canvas=document.createElement("canvas");canvas.width=json.width?json.width*this.zoom:100,canvas.height=json.height?json.height*this.zoom:100,console.log(canvas);var myChart=echarts.init(canvas),data=json.data||{};if(data.hasOwnProperty("handle"))for(let i=0;i<json.data.handle.length;i++)eval(data.handle[i]);myChart.setOption(data.options,!0);var CanvasRect=fabric__WEBPACK_IMPORTED_MODULE_1__.fabric.util.createClass(fabric__WEBPACK_IMPORTED_MODULE_1__.fabric.Rect,{type:"canvasRect",initialize:function(e){e||(e={}),this.callSuper("initialize",e)},toObject:function(){return fabric__WEBPACK_IMPORTED_MODULE_1__.fabric.util.object.extend(this.callSuper("toObject"),{})},_render:function(e){this.callSuper("_render",e);var t=myChart.getRenderedCanvas({pixelRatio:2,backgroundColor:""});e.drawImage(t,-json.width/2,-json.height/2,json.width,json.height)}});return console.log(new CanvasRect(json)),new CanvasRect(json)},getSvg:function(e){let t=this;fabric__WEBPACK_IMPORTED_MODULE_1__.fabric.Image.fromURL(e.data.imgsrc,(function(i){console.log(i),i["data"]=e.data,i.set({left:e.left,top:e.top}),i.scaleToWidth(e.width),i.scaleToHeight(e.height),t.addObject(i)}))},changeImg:function(){let _this=this;if(this.design.getActiveObject()){let objects=this.design.getObjects(),uuid=this.design.getActiveObject().data.uuid;for(let i=0;i<objects.length;i++){if(objects[i].data.uuid==uuid&&"Svg"==objects[i].data.type){console.log(objects[i]);let e="images/runstatus.svg",t=objects[i];t.data.imgsrc=e,fabric__WEBPACK_IMPORTED_MODULE_1__.fabric.Image.fromURL(e,(function(e){console.log(e),e["data"]=t.data,e.set({left:t.left,top:t.top}),e.scaleToWidth(objects[i].width*objects[i].scaleX),e.scaleToHeight(objects[i].height*objects[i].scaleY),_this.design.remove(t),_this.addObject(e)}))}if(objects[i].data.uuid==uuid&&"Echart"==objects[i].data.type){console.log(objects[i]),console.log(this.zoom);let json={width:objects[i].width,height:objects[i].height,data:objects[i].data};json.data.value=5.2;var canvas=document.createElement("canvas");canvas.width=json.width,canvas.height=json.height,console.log(canvas);var myChart=echarts.init(canvas),data=json.data||{};if(data.hasOwnProperty("handle"))for(let i=0;i<json.data.handle.length;i++)eval(data.handle[i]);myChart.setOption(data.options,!0);var offcanvas=myChart.getRenderedCanvas({pixelRatio:2,backgroundColor:""});objects[i]._cacheContext.clearRect(-json.width/2,-json.height/2,json.width,json.height),objects[i]._cacheContext.drawImage(offcanvas,-json.width/2,-json.height/2,json.width,json.height),this.design.renderAll()}}}},removeObject:function(){this.design.getActiveObject()?(console.log(this.design.getActiveObject()),this.$confirm("确定删除？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((()=>{this.design.remove(this.design.getActiveObject())}))):this.$notify.warning("请选择需要删除的对象")},saveDesign:function(){sessionStorage.setItem("canvasDesign",JSON.stringify(this.design.toDatalessJSON())),console.log(JSON.stringify(this.design.toJSON())),this.$notify.success("保存成功！")},showDesign:function(){this.$router.push({path:"/show"})},test:function(){fabric__WEBPACK_IMPORTED_MODULE_1__.fabric.backgroundImage="https://source.unsplash.com/random"},drawPolyLine:function(e){this.drawType=e,this.polygonMode=!0,this.pointArray=[],this.lineArray=[],this.design.isDrawingMode=!1},finishPolyLine:function(){this.activeLine=null,this.activeShape=null,this.polygonMode=!1,this.doDrawing=!1,this.drawType=null},generatePolygon(){var e=[];this.pointArray.map(((t,i)=>{e.push({x:t.left,y:t.top}),this.design.remove(t)})),this.lineArray.map(((e,t)=>{this.design.remove(e)})),this.design.remove(this.activeShape).remove(this.activeLine);var t=new fabric__WEBPACK_IMPORTED_MODULE_1__.fabric.Polygon(e,{stroke:this.color,strokeWidth:this.drawWidth,fill:"rgba(255, 255, 255, 0)",opacity:1,hasBorders:!0,hasControls:!1});this.design.add(t),this.finishPolyLine()},generateSegements(){this.design.remove(this.lineArray[this.lineArray.length-1]),this.lineArray.splice(this.lineArray.length-1,1);for(let e=0;e<this.pointArray.length;e++)0==e?(this.pointArray[e].startLine=null,this.pointArray[e].endLine=this.lineArray[0]):e==this.lineArray.length?(this.pointArray[e].startLine=this.lineArray[e-1],this.pointArray[e].endLine=null):(this.pointArray[e].startLine=this.lineArray[e-1],this.pointArray[e].endLine=this.lineArray[e]);this.finishPolyLine()},makeCircle:function(e,t,i,n){var s=new fabric__WEBPACK_IMPORTED_MODULE_1__.fabric.Circle({left:e,top:t,radius:5,fill:"#ffffff",stroke:"#333333",strokeWidth:.5});return s.hasControls=s.hasBorders=!1,s.startLine=i,s.endLine=n,s},addPoint(e){var t=uuid(),i=new fabric__WEBPACK_IMPORTED_MODULE_1__.fabric.Circle({radius:5,fill:"#ffffff",stroke:"#333333",strokeWidth:.5,left:(e.pointer.x||e.e.layerX)/this.design.getZoom(),top:(e.pointer.y||e.e.layerY)/this.design.getZoom(),hasBorders:!1,hasControls:!1,originX:"center",originY:"center",id:t,objectCaching:!1}),n=[(e.pointer.x||e.e.layerX)/this.design.getZoom(),(e.pointer.y||e.e.layerY)/this.design.getZoom(),(e.pointer.x||e.e.layerX)/this.design.getZoom(),(e.pointer.y||e.e.layerY)/this.design.getZoom()];if(this.line=new fabric__WEBPACK_IMPORTED_MODULE_1__.fabric.Line(n,{strokeWidth:2,fill:"#999999",stroke:"#999999",class:"line",originX:"center",originY:"center",selectable:!1,evented:!1,objectCaching:!1}),"polygon"==this.drawType)if(this.activeShape){var s=this.design.getPointer(e.e);n=this.activeShape.get("points");n.push({x:s.x,y:s.y});var o=new fabric__WEBPACK_IMPORTED_MODULE_1__.fabric.Polygon(n,{stroke:"#333333",strokeWidth:1,fill:"#cccccc",opacity:.3,selectable:!1,hasBorders:!1,hasControls:!1,evented:!1,objectCaching:!1});this.design.remove(this.activeShape),this.design.add(o),this.activeShape=o,this.design.renderAll()}else{var a=[{x:(e.pointer.x||e.e.layerX)/this.design.getZoom(),y:(e.pointer.y||e.e.layerY)/this.design.getZoom()}];o=new fabric__WEBPACK_IMPORTED_MODULE_1__.fabric.Polygon(a,{stroke:"#333333",strokeWidth:1,fill:"#cccccc",opacity:.3,selectable:!1,hasBorders:!1,hasControls:!1,evented:!1,objectCaching:!1});this.activeShape=o,this.design.add(o)}this.activeLine=this.line,this.pointArray.push(i),this.lineArray.push(this.line),this.design.add(this.line),this.design.add(i)},handleLayer:function(e){switch(console.log(e),e){case"upLayer":this.ActiveObject&&this.ActiveObject.bringForward();break;case"downLayer":this.ActiveObject&&this.ActiveObject.sendBackwards();break;case"topLayer":this.ActiveObject&&this.ActiveObject.bringToFront();break;case"footLayer":this.ActiveObject&&this.ActiveObject.sendToBack();break;case"removeLayer":this.ActiveObject&&this.$confirm("确定删除？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((()=>{console.log(this.ActiveObject),this.design.remove(this.ActiveObject),this.ActiveObject=null}));break;default:}this.contextMenuVisible=!1}},watch:{drawType(){this.design.selection=!this.drawType}}}},71718:function(e,t,i){i(57658);var n=function(){function e(e){this.config={width:500,height:24,color:"#000",background:"#fff",labelColor:"#345",labelFontSize:12,labelFontFamily:"Arial",lineWidth:1,scale:1,lastScale:1,wheelScroll:100,wheelUpNumber:1,wheelDownNumber:1,upArr:[],downArr:[],first:!0,labelScale:1,canvas:document.createElement("canvas"),start:0,beginOffset:0,endOffset:0,base:10,originOffset:0},Object.assign(this.config,e),this.checkCanvas(),this.resize()}return Object.defineProperty(e.prototype,"canvas",{get:function(){return this.config.canvas},enumerable:!1,configurable:!0}),e.prototype.resize=function(){var e=this.config,t=e.canvas,i=e.width,n=e.height;return t.width=i,t.height=n,t.style.width=i+"px",t.style.height=n+"px",this},e.prototype.render=function(){return this.beforeRender().rendering().afterRender()},e.prototype.update=function(e){var t=this.config.scale;this.config.lastScale;if(Object.assign(this.config,e),(e.width||e.height)&&this.resize(),e.scale){if(console.log(t,e.scale,this.config.wheelScroll,this.config.base,this.config.upArr,this.config.downArr),t==e.scale)return;t>e.scale?(this.config.first&&(this.config.wheelScroll--,this.config.downArr.push(10),this.config.first=!1),this.config.wheelScroll%4==0?(this.config.upArr.length>0?(this.config.base=this.config.upArr[this.config.upArr.length-1],this.config.upArr.splice(this.config.upArr.length-1,1)):(this.config.base=this.config.base+10*this.config.wheelDownNumber,this.config.wheelDownNumber++,this.config.downArr.push(this.config.base)),this.render()):this.addAnimate({type:"scale",from:t,to:e.scale}),this.config.wheelScroll--):t<e.scale&&(this.config.first&&(this.config.wheelScroll++,this.config.upArr.push(10),this.config.first=!1),this.config.wheelScroll%4==0?(this.config.downArr.length>0?(this.config.base=this.config.downArr[this.config.downArr.length-1],this.config.downArr.splice(this.config.downArr.length-1,1)):(this.config.base=this.config.base-.1*this.config.wheelDownNumber,this.config.wheelDownNumber++,this.config.downArr.push(this.config.base)),this.render()):this.addAnimate({type:"scale",from:t,to:e.scale}),this.config.wheelScroll++)}else this.render();return this},e.prototype.addAnimate=function(e){var t=this,i=e.type,n=e.from,s=e.to;if("scale"===i){var o,a=n,r=Math.sign(s-n);cancelAnimationFrame(this.animateTimer);var c=function(e){o||(o=e),a=parseFloat((a+.02*r).toFixed(2)),(s-a)*r>=0&&(Object.assign(t.config,{scale:a}),t.render(),t.animateTimer=requestAnimationFrame(c))};this.animateTimer=requestAnimationFrame(c)}return this},e.prototype.beforeRender=function(){var e=this.canvas.getContext("2d"),t=this.canvas,i=t.width,n=t.height;e.clearRect(0,0,i,n);var s=this.config.background;return e.save(),e.fillStyle=s,e.fillRect(0,0,i,n),e.restore(),this},e.prototype.rendering=function(){var e=this,t=this.canvas.getContext("2d"),i=this.canvas,n=i.width,s=i.height,o=this.config,a=o.lineWidth,r=o.scale,c=o.color,h=o.beginOffset,l=o.endOffset,d=o.base,f=o.labelScale,_=o.originOffset,g=d*r,u=[],p=[];u.push([[h,s-a/2],[n-l,s-a/2]]);var b=[],v=h+_*f,m=v,y=0;while(m>h){let e=[m-a/2,s],t=y%5?s/2:y%10?s/3:0,i=[m-a/2,t];b.push([e,i]),y%5===0&&p.push({point:i,text:String(-y*d/f),type:y%2}),m-=g,y+=1}m=v+g,y=1;while(m<n-l){let e=[m-a/2,s],t=y%5?s/2:y%10?s/3:0,i=[m-a/2,t];b.push([e,i]),y%5===0&&p.push({point:i,text:String(y*d/f),type:y%2}),m+=g,y+=1}return u.push.apply(u,b),t.save(),t.beginPath(),t.lineWidth=a,t.strokeStyle=c,u.forEach((function(e){e.forEach((function(e,i){var n=e[0],s=e[1];0===i?t.moveTo(n,s):t.lineTo(n,s)}))})),t.closePath(),t.stroke(),t.restore(),t.save(),p.forEach((function(t){var i=t.point,n=t.text,s=t.type;e.renderLabel(n,i[0],i[1],s)})),t.restore(),this},e.prototype.afterRender=function(){return this},e.prototype.renderLabel=function(e,t,i,n){var s,o,a=this.config,r=a.canvas,c=a.labelFontFamily,h=a.labelColor,l=this.config.labelFontSize,d=r.getContext("2d");switch(n){case 0:s="top",o="left",t+=1;break;case 1:s="middle",o="left",t+=1,i-=1,l-=1;break;default:break}return d.textBaseline=s,d.textAlign=o,d.font=l+"px "+c,d.fillStyle=h,d.fillText(e,t,i),this},e.prototype.checkCanvas=function(){var e=this.config,t=e.canvasId,i=e.canvasClass;return i&&(this.config.canvas=document.querySelector(t)),t&&(this.config.canvas=document.querySelector(t)),this},e.prototype.dispose=function(){return this.config=null,this},e.prototype.show=function(){return this.canvas.style.display="block",this},e.prototype.hidden=function(){return this.canvas.style.display="none",this},e}();t["Z"]=n}}]);
//# sourceMappingURL=928.5bc1235d.js.map